'use client';

import React, { useMemo, useState } from 'react';
import { useRouter } from 'next/navigation';
import useStrings from '@/hooks/useStrings';
import {
  ArrowLeft,
  LayoutGrid,
  Users,
  Hash,
  Link,
  Mail,
  Lock,
  FileText,
  AIIcon,
  Search,
} from '@/components/common/icons';
import { mockUsers, mockRecentActivities } from '@/__mocks__/users';
import { mockWorkspaceStats } from '@/__mocks__/workspaces';
import { 
  InsightsTab, 
  InviteManagementTab, 
  MembersTab,
  GroupsTab, 
  IntegrationsTab, 
  SecurityTab, 
  AuditTab 
} from './workspace/tabs';
import { useWorkspaceSettingsStore } from '@/store/workspace/useWorkspaceSettingsStore';

import AiAssistantPage from '@/app/settings/workspace/[workspaceId]/ai-assistant/ai-assistant.page';
import AiSearchSettingsPage from '@/app/settings/workspace/[workspaceId]/ai-search/page';

const navItems = [
  { id: 'overview', icon: LayoutGrid, labelKey: 'navDashboard' },
  { id: 'members', icon: Users, labelKey: 'navMembers' },
  { id: 'invite-management', icon: Mail, labelKey: 'navInviteManagement' },
  { id: 'groups', icon: Hash, labelKey: 'navGroups' },
  { id: 'integrations', icon: Link, labelKey: 'navIntegrations' },
  { id: 'security', icon: Lock, labelKey: 'navSecurity' },
  { id: 'audit', icon: FileText, labelKey: 'navAuditLog' },
  { id: 'ai-assistant', icon: AIIcon, labelKey: 'navAiAssistant' },
  { id: 'ai-search', icon: AIIcon, labelKey: 'navAiSearch' },
];

const mockInvitations = [
  { id: 'inv1', email: 'mira@company.com', status: 'pending', invitedBy: 'Alice Kim', sentAt: '2024-03-01' },
  { id: 'inv2', email: 'sunny@client.com', status: 'accepted', invitedBy: 'Bob Lee', sentAt: '2024-02-18' },
  { id: 'inv3', email: 'justin@studio.io', status: 'expired', invitedBy: 'Eve Seo', sentAt: '2024-02-05' },
];

const mockBlockedMembers = [
  { id: 'blk1', name: 'Guest Lee', email: 'guest.lee@example.com', reason: 'Suspicious activity', blockedAt: '2024-01-28' },
  { id: 'blk2', name: 'Agency Park', email: 'agency.park@example.com', reason: 'Spam invites', blockedAt: '2023-12-17' },
];

const mockInviteLinks = [
  {
    id: 'link-1',
    type: 'member',
    url: 'https://prizm.app/invite/member/wxy891',
    usage: '5',
    expiration: '7d',
    createdAt: '2024-03-12T09:12:00Z',
    createdBy: 'Alice Kim',
  },
  {
    id: 'link-2',
    type: 'guest',
    url: 'https://prizm.app/invite/guest/design-42jl',
    usage: 'unlimited',
    expiration: '30d',
    createdAt: '2024-03-05T15:45:00Z',
    createdBy: 'Bob Lee',
  },
];

const mockMemberHistory = [
  { id: 'hist1', name: 'Alice Kim', action: 'join', timestamp: '2024-01-02 09:30' },
  { id: 'hist2', name: 'David Choi', action: 'leave', timestamp: '2024-02-15 18:42' },
  { id: 'hist3', name: 'Eve Seo', action: 'join', timestamp: '2024-02-26 11:14' },
  { id: 'hist4', name: 'Guest Lee', action: 'invited', timestamp: '2024-03-01 08:20' },
];

const mockGroups = [
  {
    id: 'grp1',
    name: 'Product Team',
    description: '제품 기획 및 디자인 담당',
    members: 12,
    channels: ['general', 'product-design', 'roadmap'],
  },
  {
    id: 'grp2',
    name: 'Customer Success',
    description: '고객 문의 및 지원 담당',
    members: 8,
    channels: ['general', 'support', 'bug-report'],
  },
  {
    id: 'grp3',
    name: 'External Contractors',
    description: '외부 파트너 협업용 그룹',
    members: 5,
    channels: ['general', 'handover', 'assets-share'],
  },
];

const workspaceChannels = ['general', 'product-design', 'roadmap', 'support', 'bug-report', 'handover', 'assets-share', 'random'];

const WorkspaceSettingsPage = ({ onBack }) => {
  const router = useRouter();
  const s = useStrings();
  const [currentTab, setCurrentTab] = useState('overview');
  const invitations = useMemo(() => mockInvitations, []);
  const blockedMembers = useMemo(() => mockBlockedMembers, []);
  const membershipHistory = useMemo(() => mockMemberHistory, []);
  const groups = useMemo(() => mockGroups, []);
  const inviteLinks = useMemo(() => mockInviteLinks, []);
  const stats = useMemo(
    () =>
      mockWorkspaceStats.map((stat) => ({
        ...stat,
        label:
          stat.id === 'members'
            ? s.workspaceAdmin.statMembers
            : stat.id === 'channels'
            ? s.workspaceAdmin.statChannels
            : stat.id === 'messages'
            ? s.workspaceAdmin.statMessages
            : s.workspaceAdmin.statActiveUsers,
      })),
    [s],
  );
  const members = useMemo(() => Object.values(mockUsers), []);
  const participants = useMemo(
    () =>
      members.map((member) => ({
        id: member.id,
        name: member.realName || member.name,
        displayName: member.name,
        email: member.email,
        role: member.role,
        status: member.status,
        type: member.role === 'Guest' ? 'Guest' : 'Member',
        group: member.role === 'Guest' ? 'External Contractors' : 'Core Team',
        avatar: member.avatar,
      })),
    [members],
  );
  const [groupPermissions, setGroupPermissions] = useState(() =>
    mockGroups.reduce((acc, group) => {
      acc[group.id] = group.channels;
      return acc;
    }, {}),
  );

  const handleBack = () => {
    if (onBack) {
      onBack();
      return;
    }
    router.back();
  };

  const handleToggleGroupChannel = (groupId, channelId) => {
    setGroupPermissions((prev) => {
      const current = prev[groupId] || [];
      const exists = current.includes(channelId);
      const nextChannels = exists
        ? current.filter((id) => id !== channelId)
        : [...current, channelId];
      return {
        ...prev,
        [groupId]: nextChannels,
      };
    });
  };

  // renderContent 간소화 - 탭 컴포넌트 사용
  const renderContent = () => {
    switch (currentTab) {
      case 'overview':
        return <InsightsTab stats={stats} activities={mockRecentActivities} />;
      
      case 'invite-management':
        return <InviteManagementTab invitations={invitations} inviteLinks={inviteLinks} />;
      
      case 'members':
        return (
          <MembersTab
            blockedMembers={blockedMembers}
            participants={participants}
            membershipHistory={membershipHistory}
          />
        );
      
      case 'groups':
        return (
          <GroupsTab
            groups={groups}
            workspaceChannels={workspaceChannels}
            groupPermissions={groupPermissions}
            onToggleGroupChannel={handleToggleGroupChannel}
          />
        );
      
      case 'integrations':
        return <IntegrationsTab />;
      
      case 'security':
        return <SecurityTab />;
      
      case 'audit':
        return <AuditTab activities={mockRecentActivities} />;
      
      case 'ai-assistant':
        return <AiAssistantPage />;
      
      case 'ai-search':
        return <AiSearchSettingsPage />;
      
      default:
        return <InsightsTab stats={stats} activities={mockRecentActivities} />;
    }
  };

  return (
    <div className="settings-page">
      <aside className="settings-sidebar">
        <button onClick={handleBack} className="settings-sidebar__back-button">
          <ArrowLeft size={16} />
          <span>{s.workspaceAdmin.backToWorkspace}</span>
        </button>
        <h3 className="settings-sidebar__title">
          <LayoutGrid size={16} />
          <span>Prizm Dev</span>
        </h3>
        <nav className="settings-sidebar__nav">
          {navItems.map(({ id, icon: Icon, labelKey }) => (
            <button
              key={id}
              className={`settings-sidebar__button ${currentTab === id ? 'active' : ''}`}
              onClick={() => setCurrentTab(id)}
            >
              <Icon size={16} />
              <span>{s.workspaceAdmin[labelKey]}</span>
            </button>
          ))}
        </nav>
      </aside>
      <main className="settings-content">{renderContent()}</main>
    </div>
  );
};

export default WorkspaceSettingsPage;
